<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Now Playing Overlay</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap");
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Geist", -apple-system, BlinkMacSystemFont, "Segoe UI",
          system-ui, sans-serif;
        background: transparent;
        overflow: hidden;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .now-playing-container {
        position: relative;
        width: 800px;
        height: 120px;
        max-width: 95vw;
        background: linear-gradient(
          135deg,
          rgba(15, 15, 15, 0.95) 0%,
          rgba(25, 25, 25, 0.95) 100%
        );
        backdrop-filter: blur(24px) saturate(180%);
        border-radius: 20px;
        padding: 20px 24px;
        color: #fff;
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .now-playing-container.show {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      .track-info {
        display: flex;
        align-items: flex-end;
        gap: 20px;
        flex: 1;
        min-width: 0;
      }
      .album-cover-container {
        position: relative;
        flex-shrink: 0;
      }
      .album-cover {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }
      .album-cover.playing {
        animation: albumPulse 3s ease-in-out infinite;
      }
      @keyframes albumPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }
      .vinyl-effect {
        display: none;
      }
      .track-details {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 80px;
        position: relative;
      }
      .track-text-info {
        display: flex;
        flex-direction: column;
        gap: 1px;
        flex-shrink: 1;
        overflow: hidden;
        align-self: flex-start;
      }
      .scrolling-text {
        overflow: hidden;
        white-space: nowrap;
        position: relative;
      }
      .scrolling-text .text-content {
        display: inline-block;
        animation: scrollText 20s ease-in-out infinite;
        padding-right: 100px;
      }
      .scrolling-text.no-scroll .text-content {
        animation: none;
        padding-right: 0;
      }
      @media (max-width: 900px) {
        .scrolling-text .text-content {
          padding-right: 80px;
          animation-duration: 18s;
        }
      }
      @media (max-width: 600px) {
        .scrolling-text .text-content {
          padding-right: 60px;
          animation-duration: 16s;
        }
      }
      @media (max-width: 400px) {
        .scrolling-text .text-content {
          padding-right: 40px;
          animation-duration: 14s;
        }
      }
      @keyframes scrollText {
        0%,
        30% {
          transform: translateX(0);
        }
        60%,
        90% {
          transform: translateX(calc(-100% + 100vw - 150px));
        }
        100% {
          transform: translateX(0);
        }
      }
      @media (max-width: 900px) {
        @keyframes scrollText {
          0%,
          30% {
            transform: translateX(0);
          }
          60%,
          90% {
            transform: translateX(calc(-100% + 95vw - 120px));
          }
          100% {
            transform: translateX(0);
          }
        }
      }
      @media (max-width: 600px) {
        @keyframes scrollText {
          0%,
          30% {
            transform: translateX(0);
          }
          60%,
          90% {
            transform: translateX(calc(-100% + 90vw - 100px));
          }
          100% {
            transform: translateX(0);
          }
        }
      }
      @media (max-width: 400px) {
        @keyframes scrollText {
          0%,
          30% {
            transform: translateX(0);
          }
          60%,
          90% {
            transform: translateX(calc(-100% + 85vw - 80px));
          }
          100% {
            transform: translateX(0);
          }
        }
      }
      .track-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 2px;
        color: #fff;
        line-height: 1.1;
      }
      .track-artist {
        font-size: 15px;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1px;
        line-height: 1.1;
      }
      .track-album {
        font-size: 11px;
        font-weight: 300;
        color: rgba(255, 255, 255, 0.5);
        line-height: 1.1;
      }
      .progress-container {
        display: flex;
        flex-direction: column;
        gap: 3px;
        width: 100%;
        flex-shrink: 0;
      }
      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .progress-time {
        font-size: 10px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
        font-variant-numeric: tabular-nums;
        line-height: 1;
      }
      .progress-bar {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-color, #00ff88),
          var(--accent-color-light, #66ffb3)
        );
        border-radius: 2px;
        transition: width 0.8s ease-out;
        position: relative;
      }
      .progress-fill::after {
        content: "";
        position: absolute;
        top: 0;
        right: -1px;
        width: 3px;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 1px;
      }
      .wave-visualizer {
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent-color, #00ff88),
          transparent
        );
        opacity: 0.6;
        animation: waveMove 3s ease-in-out infinite;
      }
      @keyframes waveMove {
        0%,
        100% {
          transform: scaleX(1);
          opacity: 0.6;
        }
        50% {
          transform: scaleX(1.1);
          opacity: 0.8;
        }
      }
      .error-message {
        text-align: center;
        color: #ff6b6b;
        font-size: 14px;
        font-weight: 500;
        padding: 32px;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 16px;
        border: 1px solid rgba(255, 107, 107, 0.2);
      }
      @media (max-width: 900px) {
        .now-playing-container {
          width: 95vw;
          padding: 16px 20px;
          height: auto;
        }
        .track-info {
          width: 100%;
          gap: 16px;
        }
        .progress-container {
          width: 100%;
        }
      }
      @media (max-width: 600px) {
        .album-cover {
          width: 60px;
          height: 60px;
        }
        .track-details {
          height: 60px;
        }
        .track-title {
          font-size: 16px;
        }
        .track-artist {
          font-size: 12px;
        }
        .track-album {
          font-size: 10px;
        }
      }
      @media (max-width: 150px) {
        .now-playing-container {
          width: 100px;
          height: 100px;
          padding: 10px;
          border-radius: 12px;
          display: flex;
          justify-content: center;
          align-items: center;
        }
        .track-info {
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 0;
          width: 100%;
          height: 100%;
        }
        .track-details {
          display: none;
        }
        .album-cover {
          width: 80px;
          height: 80px;
          border-radius: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="now-playing-container" id="nowPlayingContainer">
      <div class="track-info">
        <div class="album-cover-container">
          <img class="album-cover" id="albumCover" src="" alt="Album Cover" />
          <div class="vinyl-effect"></div>
        </div>
        <div class="track-details">
          <div class="track-text-info">
            <div class="track-title scrolling-text">
              <span class="text-content" id="trackTitle">-</span>
            </div>
            <div class="track-artist scrolling-text">
              <span class="text-content" id="trackArtist">-</span>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-info">
              <span class="progress-time" id="currentTime">0:00</span>
              <span class="progress-time" id="totalTime">0:00</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
              <div class="wave-visualizer"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="error-message" id="errorMessage" style="display: none">
      Impossible de récupérer les informations de lecture
    </div>

    <script>
      class NowPlayingOverlay {
        constructor() {
          const ref = location.pathname.split("/")[1];
          const url = new URL(location.href);
          const d = url.searchParams.get("default");
          const q = d ? `?default=${encodeURIComponent(d)}` : "";
          this.apiInfos = `/${ref}/infos${q}`;
          this.apiColor = `/${ref}/color${q}`;
          this.updateInterval = 1000;
          this.isVisible = false;
          this.currentTrackId = null;
          this.progressAnimationId = null;
          this.initElements();
          this.startUpdating();
        }

        initElements() {
          this.container = document.getElementById("nowPlayingContainer");
          this.errorMessage = document.getElementById("errorMessage");
          this.albumCover = document.getElementById("albumCover");
          this.trackTitle = document.getElementById("trackTitle");
          this.trackArtist = document.getElementById("trackArtist");
          this.currentTime = document.getElementById("currentTime");
          this.totalTime = document.getElementById("totalTime");
          this.progressFill = document.getElementById("progressFill");
        }

        checkTextOverflow(element) {
          const container = element.parentElement;
          const shouldScroll = element.scrollWidth > container.clientWidth;
          if (shouldScroll) {
            container.classList.remove("no-scroll");
            const screenWidth = window.innerWidth;
            const textRatio = element.scrollWidth / container.clientWidth;
            let baseDuration = 20;
            if (screenWidth <= 400) baseDuration = 14;
            else if (screenWidth <= 600) baseDuration = 16;
            else if (screenWidth <= 900) baseDuration = 18;
            const duration = Math.max(baseDuration, textRatio * baseDuration);
            element.style.animationDuration = duration + "s";
          } else {
            container.classList.add("no-scroll");
            element.style.animationDuration = "";
          }
          return shouldScroll;
        }

        async fetchData() {
          const [ri, rc] = await Promise.all([
            fetch(this.apiInfos, { cache: "no-store" }),
            fetch(this.apiColor, { cache: "no-store" }),
          ]);
          if (!ri.ok) throw new Error("HTTP " + ri.status);
          const ji = await ri.json();
          let colorHex = null;
          try {
            const jc = await rc.json();
            colorHex = jc?.color?.hex || null;
          } catch (_) {}
          return { track: ji.track, colorHex };
        }

        formatTime(ms) {
          const s = Math.floor((ms || 0) / 1000);
          const m = Math.floor(s / 60);
          const rs = s % 60;
          return `${m}:${rs.toString().padStart(2, "0")}`;
        }

        updateProgress(progressMs, durationMs, isPlaying) {
          if (this.progressAnimationId) {
            cancelAnimationFrame(this.progressAnimationId);
            this.progressAnimationId = null;
          }
          const pct = durationMs
            ? Math.min((progressMs / durationMs) * 100, 100)
            : 0;
          this.progressFill.style.width = `${pct}%`;
          this.currentTime.textContent = this.formatTime(progressMs);
          this.totalTime.textContent = this.formatTime(durationMs);
          if (isPlaying) this.animateProgress(progressMs, durationMs);
        }

        animateProgress(startProgressMs, durationMs) {
          const startTime = performance.now();
          const initial = startProgressMs || 0;
          const animate = (now) => {
            const elapsed = now - startTime;
            const newMs = Math.min(initial + elapsed, durationMs || 0);
            const pct = durationMs
              ? Math.min((newMs / durationMs) * 100, 100)
              : 0;
            this.progressFill.style.width = `${pct}%`;
            this.currentTime.textContent = this.formatTime(newMs);
            if (newMs < (durationMs || 0))
              this.progressAnimationId = requestAnimationFrame(animate);
            else {
              this.progressAnimationId = null;
              this.progressFill.style.width = "100%";
            }
          };
          this.progressAnimationId = requestAnimationFrame(animate);
        }

        lightenColor(hex, percent) {
          const num = parseInt((hex || "#000000").replace("#", ""), 16);
          const amt = Math.round(2.55 * percent);
          const R = (num >> 16) + amt,
            G = ((num >> 8) & 0x00ff) + amt,
            B = (num & 0x0000ff) + amt;
          const clamp = (v) => Math.max(0, Math.min(255, v));
          const val = (clamp(R) << 16) + (clamp(G) << 8) + clamp(B);
          return "#" + val.toString(16).padStart(6, "0");
        }

        updateUI(track, colorHex) {
          const isNew = this.currentTrackId !== track?.id;
          if (isNew) {
            this.currentTrackId = track?.id || null;
            if (this.progressAnimationId) {
              cancelAnimationFrame(this.progressAnimationId);
              this.progressAnimationId = null;
            }
            this.progressFill.style.width = "0%";
          }
          this.trackTitle.textContent = track?.name || "-";
          this.trackArtist.textContent = track?.artist || "-";
          setTimeout(() => {
            this.checkTextOverflow(this.trackTitle);
            this.checkTextOverflow(this.trackArtist);
          }, 100);
          window.addEventListener("resize", () => {
            setTimeout(() => {
              this.checkTextOverflow(this.trackTitle);
              this.checkTextOverflow(this.trackArtist);
            }, 100);
          });
          if (track?.image_url) {
            this.albumCover.src = track.image_url;
            this.albumCover.alt = `${track.album || ""} - ${
              track.artist || ""
            }`;
          }
          this.albumCover.className = track?.is_playing
            ? "album-cover playing"
            : "album-cover";
          this.updateProgress(
            track?.progress_ms || 0,
            track?.duration_ms || 0,
            !!track?.is_playing
          );
          if (colorHex) {
            const light = this.lightenColor(colorHex, 20);
            document.documentElement.style.setProperty(
              "--accent-color",
              colorHex
            );
            document.documentElement.style.setProperty(
              "--accent-color-light",
              light
            );
          }
          if (track?.is_playing) this.showOverlay();
          else this.hideOverlay();
        }

        showOverlay() {
          if (!this.isVisible) {
            this.container.classList.add("show");
            this.errorMessage.style.display = "none";
            this.isVisible = true;
          }
        }
        hideOverlay() {
          if (this.isVisible) {
            this.container.classList.remove("show");
            this.isVisible = false;
            if (this.progressAnimationId) {
              cancelAnimationFrame(this.progressAnimationId);
              this.progressAnimationId = null;
            }
          }
        }

        async update() {
          try {
            const { track, colorHex } = await this.fetchData();
            if (track && track.id) this.updateUI(track, colorHex);
            else this.hideOverlay();
          } catch (e) {
            this.hideOverlay();
          }
        }

        startUpdating() {
          this.update();
          setInterval(() => this.update(), this.updateInterval);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new NowPlayingOverlay();
      });
      window.addEventListener("error", (e) => {
        console.error("Erreur globale:", e.error);
      });
    </script>
  </body>
</html>
