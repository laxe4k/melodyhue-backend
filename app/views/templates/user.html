<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="titlePage">Profil</title>
    <link rel="stylesheet" href="/static/css/base.css" />
    <link rel="stylesheet" href="/static/css/pages/user.css" />
  </head>
  <body>
    <div class="shell">
      <div class="row user-header">
        <div class="cover">
          <div id="cover_ph" class="cover-ph" aria-hidden="true">üéµ</div>
          <img id="cover" alt="Cover" />
        </div>
        <div>
          <h1 id="title">{{ username or 'Profil' }}</h1>
          <div class="muted mt-1">
            UUID: <span id="uuid">{{ user_uuid or '' }}</span>
          </div>
          <div class="actions">
            <a id="lnp" href="#" class="btn primary">Voir Now Playing</a>
            <a id="lcf" href="#" class="btn">Couleur plein √©cran</a>
            <a id="lset" href="#" class="btn">R√©glages</a>
            <button id="btn_logout" class="btn red" type="button">
              D√©connexion
            </button>
          </div>
        </div>
      </div>
      <div class="grid user-grid mt-3">
        <div class="card nowp">
          <div class="pill">Now Playing</div>
          <div id="np" class="np-wrap">
            <div class="np-row">
              <div id="np_title" class="np-title">-</div>
              <div id="np_state" class="status">
                <span class="status-dot"></span
                ><span id="np_state_text" class="muted">Pause</span>
              </div>
            </div>
            <div id="np_artist" class="np-artist">&nbsp;</div>
            <div id="np_album" class="np-album">&nbsp;</div>
            <div class="progress" id="np_progress">
              <div class="bar" id="np_bar"></div>
            </div>
            <div class="np-times">
              <span id="np_elapsed">0:00</span
              ><span id="np_duration">0:00</span>
            </div>
          </div>
        </div>
        <div class="card color-card">
          <div class="pill">Couleur</div>
          <div id="hex" class="hex-display mt-2"></div>
          <div id="sw" class="sw"></div>
        </div>
        <div class="card endpoints-card">
          <div class="pill">Endpoints (copier-coller)</div>
          <div class="endpoint mt-2">
            <span class="method">GET</span>
            <code id="e_infos"></code>
            <button onclick="copyText('e_infos', this)">Copier</button>
          </div>
          <div class="endpoint mt-2">
            <span class="method">GET</span>
            <code id="e_color"></code>
            <button onclick="copyText('e_color', this)">Copier</button>
          </div>
          <div class="endpoint mt-2">
            <span class="method">HTML</span>
            <code id="e_nowp"></code>
            <button onclick="copyText('e_nowp', this)">Copier</button>
          </div>
          <div class="endpoint mt-2">
            <span class="method">HTML</span>
            <code id="e_full"></code>
            <button onclick="copyText('e_full', this)">Copier</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const ref = location.pathname.split("/")[1];
      const titleEl = document.getElementById("title");
      const titlePage = document.getElementById("titlePage");
      const tplUser = titleEl.textContent.trim();
      const tplUuid = document.getElementById("uuid").textContent.trim();
      const api = (ep) => {
        const url = new URL(location.href);
        const d = url.searchParams.get("default");
        const q = d ? `?default=${encodeURIComponent(d)}` : "";
        return `/${ref}/${ep}${q}`;
      };
      const copyText = (id, btn) => {
        const el = document.getElementById(id);
        const t = (el && (el.dataset?.full || el.textContent)) || "";
        const done = () => {
          if (btn) {
            const old = btn.textContent;
            btn.textContent = "Copi√©!";
            btn.disabled = true;
            setTimeout(() => {
              btn.textContent = old;
              btn.disabled = false;
            }, 1200);
          }
        };
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(t).then(done).catch(done);
        } else {
          done();
        }
      };
      const isUuid = (s) => /^[0-9a-fA-F-]{36}$/.test(s || "");
      // State Now Playing pour progression locale fluide
      let npState = {
        id: null,
        duration: 0,
        progress: 0,
        isPlaying: false,
        lastTs: 0,
        accent: "#69b3ff",
      };
      const msToTime = (ms) => {
        ms = Math.max(0, Math.floor(ms || 0));
        const m = Math.floor(ms / 60000);
        const s = Math.floor((ms % 60000) / 1000)
          .toString()
          .padStart(2, "0");
        return `${m}:${s}`;
      };
      const updateProgressUI = () => {
        const bar = document.getElementById("np_bar");
        const e = document.getElementById("np_elapsed");
        const d = document.getElementById("np_duration");
        const pct =
          npState.duration > 0
            ? Math.min(100, (npState.progress / npState.duration) * 100)
            : 0;
        bar.style.width = `${pct}%`;
        bar.style.backgroundColor = npState.accent;
        e.textContent = msToTime(npState.progress);
        d.textContent = msToTime(npState.duration);
      };
      // Tick local (chaque seconde) pour faire avancer la barre sans refetch constant
      let npTimer = null;
      const ensureNpTimer = () => {
        if (npTimer) return;
        npTimer = setInterval(() => {
          if (npState.isPlaying && npState.duration > 0) {
            const now = Date.now();
            const dt = now - (npState.lastTs || now);
            npState.progress = Math.min(
              npState.duration,
              npState.progress + dt
            );
            npState.lastTs = now;
            updateProgressUI();
          }
        }, 1000);
      };
      async function refresh() {
        try {
          const infosRes = await fetch(api("infos"), { cache: "no-store" });
          const info = await infosRes.json();
          const hex = info?.color?.hex || "#000000";
          document.getElementById("hex").textContent = hex;
          document.getElementById("sw").style.backgroundColor = hex;
          const track = info?.track || {};
          const coverEl = document.getElementById("cover");
          const coverPh = document.getElementById("cover_ph");
          if (track.image_url) {
            coverEl.src = track.image_url;
            coverEl.style.display = "block";
            coverPh.style.display = "none";
          } else {
            coverEl.removeAttribute("src");
            coverEl.style.display = "none";
            coverPh.style.display = "grid";
          }
          // Now Playing enrichi
          document.getElementById("np_title").textContent = track.name || "-";
          document.getElementById("np_artist").textContent = track.artist || "";
          document.getElementById("np_album").textContent = track.album
            ? `‚Ä¢ ${track.album}`
            : "";
          const stateEl = document.getElementById("np_state");
          const stateText = document.getElementById("np_state_text");
          const playing = !!track.is_playing;
          stateEl.classList.toggle("playing", playing);
          stateText.textContent = playing ? "Lecture" : "Pause";
          // Progression
          const duration = Number(track.duration_ms) || 0;
          const progress = Math.min(Number(track.progress_ms) || 0, duration);
          npState.id = track.id || null;
          npState.duration = duration;
          npState.progress = progress;
          npState.isPlaying = playing;
          npState.lastTs = Date.now();
          npState.accent = hex;
          updateProgressUI();
          ensureNpTimer();
          const reportedUser = info?.user || "";
          const uname =
            !reportedUser || isUuid(reportedUser)
              ? tplUser || reportedUser
              : reportedUser;
          const uid = info?.uuid || tplUuid || ref;
          document.getElementById("uuid").textContent = uid;
          titleEl.textContent = uname || "Profil";
          titlePage.textContent = uname ? `Profil - ${uname}` : "Profil";
          // Propager ?default=... si pr√©sent dans l'URL
          const url = new URL(location.href);
          const d = url.searchParams.get("default");
          const q = d ? `?default=${encodeURIComponent(d)}` : "";
          document.getElementById("lnp").href = `/${ref}/nowplaying${q}`;
          document.getElementById("lcf").href = `/${ref}/color-fullscreen${q}`;
          // Texte simple remplac√© par les √©l√©ments d√©taill√©s ci-dessus
          // endpoints
          const eInfos = document.getElementById("e_infos");
          const eColor = document.getElementById("e_color");
          const eNowp = document.getElementById("e_nowp");
          const eFull = document.getElementById("e_full");
          // Afficher chemin court pour lisibilit√©, copier l'URL compl√®te
          // Pr√©f√©rer /<ref>/infos qui inclut d√©j√† la couleur
          eInfos.textContent = api("infos");
          eInfos.dataset.full = location.origin + api("infos");
          // /<ref>/color reste disponible si n√©cessaire
          eColor.textContent = api("color");
          eColor.dataset.full = location.origin + api("color");
          eNowp.textContent = `/${ref}/nowplaying${q}`;
          eNowp.dataset.full = location.origin + `/${ref}/nowplaying${q}`;
          eFull.textContent = `/${ref}/color-fullscreen${q}`;
          eFull.dataset.full = location.origin + `/${ref}/color-fullscreen${q}`;
          // r√©glages: utiliser UUID exclusivement
          if (uid) {
            document.getElementById("lset").href = `/${encodeURIComponent(
              uid
            )}/settings`;
          }
        } catch (e) {
          console.error(e);
        }
      }
      refresh();
      setInterval(refresh, 6000);

      // D√©connexion de l'utilisateur (session)
      const logoutBtn = document.getElementById("btn_logout");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await fetch("/logout", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
            });
          } catch (_) {}
          // Rediriger vers la page de login apr√®s purge de session
          location.href = "/login";
        });
      }
    </script>
    {% include '_footer.html' %}
  </body>
</html>
